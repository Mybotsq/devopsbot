# devopsbot

# Описание
***

**docker-compose**: Для запуска и старта проекта используются официальные образы postgresql и python3.9-slim из DockerHub. В процессе работы скачиваются и изменяются автоматически.

**Ansible**: Для запуска и старта проекта используется 2 виртуальных машины. На 1-ой будет находится основная база данных и телеграмм бот. На 2-ой база база данных для репликации

P.S. Pаботоспособность проверялась на виртуалках с Ubuntu 20.04 и Ubuntu 22.04

# Запуск через docker-compose
*** 
1. Клонировать ветку `docker` этого репозитория 

  
2. Перейти в папку `devopsbot`  



3. Добавить .env файл со всеми необходимыми переменными. Структура будет приведена ниже


4. Выполнить команду ```docker-compose up --build``` для автоматического создания образов и запуска контейнеров 



# Запуск через Ansible
***
> На основной машине, с которой будет происходит запуск плейбука ansible предполагается наличие устанвленных пакетов python3, python3-pip, ansible и sshpass. Иначе как вы установили ansible?)

1. Убедиться в том, что на всех машинах существует пользователь `ansible`


2. На всех машинах в файле `/etc/sudoers` для пользователя выставлен запуск команд от имени `root` без ввода пароля `ansible ALL=(ALL:ALL) NOPASSWD:ALL`


3. Для пользователя `root` включен доступ по ssh. Необходимо для выполнения команд из скрипта и сбора логов. В конфигурационном файле `/etc/ssh/sshd_config`
``` 
PermitRootLogin yes
```

4. Отредактировать файл inventory

5. Выполнить запуск командой `ansible-playbook playbook-tg-bot.yml`


## Структура .env файла
```
TOKEN = token - будет содержать токен бота
 RM_HOST = rm_host - будет содержать удаленный хост, который будем мониторить
 RM_PORT = rm_port - будет содержать порт удаленного хоста, к которому будем подключаться
 RM_USER = rm_user - будет содержать пользователя удаленного хоста
 RM_PASSWORD = rm_password - будет содержать пароль пользователя удаленного хоста
 DB_USER = db_user - будет содержать пользователя базы данных удаленного хоста
 DB_PASSWORD = db_password - будет содержать пароль пользователя базы данных удаленного хоста
 DB_HOST = db_host - будет содержать хост(имя контейнера), в котором будет работать база данных
 DB_PORT = db_port - будет содержать порт, на котором работает база данных
 DB_DATABASE = db_database - будет содержать имя базы данных
 DB_REPL_USER = db_repl_user - будет содержать пользователя реплицируемой базы данных
 DB_REPL_PASSWORD = db_repl_password - будет содержать пароль пользователя реплицируемой базы данных
 DB_REPL_HOST = db_repl_host - будет содержать хост(имя контейнера), в котором будет работать реплицируемая база данных
 DB_REPL_PORT = db_repl_port - будет содержать порт, на котором работает реплицируемая база данных

```

